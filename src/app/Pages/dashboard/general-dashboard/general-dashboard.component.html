<div class="d-flex" id="wrapper">
  <!-- Sidebar (desktop) -->
  <aside
    class="bg-white border-end sticky-top d-none d-md-block"
    id="sidebar"
    style="min-width: 250px; height: 100vh; overflow-y: auto"
  >
    <div
      class="sidebar-heading text-center py-4 fs-4 fw-bold text-primary border-bottom mb-3"
    >
      <i class="bi bi-controller me-2"></i>QuizVerse
    </div>
    <div class="list-group list-group-flush px-2">
      <button
        class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'dashboard'"
        (click)="switchView('dashboard')"
      >
        <i class="bi bi-grid-1x2-fill me-2"></i> Dashboard
      </button>

      <button
        class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'library'"
        (click)="switchView('library')"
      >
        <i class="bi bi-collection-play me-2"></i> My Library
      </button>

      <button
        class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'history'"
        (click)="switchView('history')"
      >
        <i class="bi bi-clock-history me-2"></i> History
      </button>

      <button
        class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'settings'"
        (click)="switchView('settings')"
      >
        <i class="bi bi-gear me-2"></i> Profile & Settings
      </button>

      <button
        class="list-group-item list-group-item-action text-danger border-0 mt-4"
        (click)="logout()"
      >
        <i class="bi bi-box-arrow-left me-2"></i> Logout
      </button>
    </div>
  </aside>

  <!-- Offcanvas sidebar for small devices (Bootstrap) -->
  <div
    class="offcanvas offcanvas-start d-md-none"
    tabindex="-1"
    id="mobileSidebar"
    aria-labelledby="mobileSidebarLabel"
  >
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileSidebarLabel">
        <i class="bi bi-controller me-2"></i>QuizVerse
      </h5>
      <button
        type="button"
        class="btn-close text-reset"
        data-bs-dismiss="offcanvas"
        aria-label="Close"
      ></button>
    </div>
    <div class="offcanvas-body p-0">
      <div class="list-group list-group-flush px-2">
        <button
          class="list-group-item list-group-item-action border-0 rounded mb-2"
          [class.active-tab]="currentView === 'dashboard'"
          (click)="switchView('dashboard')"
          data-bs-dismiss="offcanvas"
        >
          <i class="bi bi-grid-1x2-fill me-2"></i> Dashboard
        </button>

        <button
          class="list-group-item list-group-item-action border-0 rounded mb-2"
          [class.active-tab]="currentView === 'library'"
          (click)="switchView('library')"
          data-bs-dismiss="offcanvas"
        >
          <i class="bi bi-collection-play me-2"></i> My Library
        </button>

        <button
          class="list-group-item list-group-item-action border-0 rounded mb-2"
          [class.active-tab]="currentView === 'history'"
          (click)="switchView('history')"
          data-bs-dismiss="offcanvas"
        >
          <i class="bi bi-clock-history me-2"></i> History
        </button>

        <button
          class="list-group-item list-group-item-action border-0 rounded mb-2"
          [class.active-tab]="currentView === 'settings'"
          (click)="switchView('settings')"
          data-bs-dismiss="offcanvas"
        >
          <i class="bi bi-gear me-2"></i> Settings
        </button>

        <button
          class="list-group-item list-group-item-action text-danger border-0 mt-4"
          (click)="logout()"
        >
          <i class="bi bi-box-arrow-left me-2"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Page content -->
  <div id="page-content-wrapper" class="w-100 bg-light">
    <!-- Top navbar -->
    <nav
      class="navbar navbar-light bg-white border-bottom shadow-sm px-3 px-md-4 py-2"
    >
      <div class="d-flex align-items-center w-100">
        <!-- Mobile toggle -->
        <button
          class="btn d-md-none me-3 p-0"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileSidebar"
          aria-controls="mobileSidebar"
          aria-label="Toggle navigation"
        >
          <i class="bi bi-list fs-3 text-dark"></i>
        </button>

        <div class="d-flex align-items-center">
          <h5
            class="m-0 fw-bold text-dark text-uppercase small text-truncate"
            style="max-width: 220px"
          >
            {{ currentView }}
          </h5>
        </div>

        <div
          class="ms-auto d-flex align-items-center"
          style="cursor: pointer"
          (click)="switchView('settings')"
        >
          <span class="me-3 text-muted small d-none d-sm-inline"
            >Welcome, <strong>{{ currentUser.name }}</strong></span
          >
          <img
            *ngIf="currentUser.profileImageUrl"
            [src]="currentUser.profileImageUrl"
            class="rounded-circle border"
            width="40"
            height="40"
            style="object-fit: cover"
          />
          <div
            *ngIf="!currentUser.profileImageUrl"
            class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center fw-bold"
            style="width: 40px; height: 40px"
          >
            {{ currentUser.name.charAt(0) | uppercase }}
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid p-3 p-md-4">
      <div
        *ngIf="currentView === 'dashboard'"
        class="animate__animated animate__fadeIn"
      >
        <div class="row justify-content-center mb-4">
          <div class="col-12 col-sm-10 col-md-8 col-lg-6">
            <div
              class="card shadow-sm border-0 bg-white rounded-3 text-center p-4 p-md-5"
            >
              <h3 class="fw-bold mb-3">Join a Live Quiz</h3>
              <p class="text-muted mb-3 small">
                Enter the code shared by your host
              </p>
              <div class="input-group input-group-lg mb-3 shadow-sm">
                <input
                  type="text"
                  class="form-control border-primary"
                  placeholder="e.g. A7X-99Q"
                  [(ngModel)]="joinCode"
                  style="text-transform: uppercase"
                />
                <button
                  class="btn btn-primary px-4 fw-bold"
                  type="button"
                  (click)="joinQuiz()"
                >
                  JOIN <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-sm-6 col-md-4">
            <div class="card shadow-sm border-0 h-100 bg-primary text-white">
              <div class="card-body p-3 p-md-4">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="text-white-50 small">Created</h6>
                    <h1 class="mb-0 fw-bold">{{ myQuizzes.length }}</h1>
                  </div>
                  <i
                    class="bi bi-plus-circle fs-1 text-white-50"
                    style="cursor: pointer"
                    (click)="openCreateModal()"
                  ></i>
                </div>
                <button
                  class="btn btn-light text-primary w-100 mt-3 fw-bold"
                  (click)="openCreateModal()"
                >
                  + Create New
                </button>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-md-4">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-body p-3 p-md-4">
                <h6 class="text-muted small">Attempted</h6>
                <h1 class="mb-0 fw-bold text-dark">{{ attemptedCount }}</h1>
                <p class="text-success mb-0 mt-2 small">
                  <i class="bi bi-graph-up"></i> Active Learner
                </p>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-md-4">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-body p-3 p-md-4">
                <h6 class="text-muted small">Avg Score</h6>
                <h1 class="mb-0 fw-bold text-dark">{{ avgScorePercent }}%</h1>
                <p class="text-muted mb-0 mt-2 small">
                  {{
                    avgScorePercent >= 50 ? "Great job!" : "Keep practicing!"
                  }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold m-0">Recent Quizzes</h5>
          <button
            class="btn btn-link text-decoration-none"
            (click)="switchView('library')"
          >
            View All
          </button>
        </div>

        <div class="row">
          <div
            class="col-12 col-md-6 col-lg-4 mb-3"
            *ngFor="let quiz of myQuizzes.slice(0, 3)"
          >
            <div class="card shadow-sm border-0 h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                  <span class="badge bg-light text-dark border text-truncate">{{
                    quiz.code
                  }}</span>
                  <span
                    class="badge"
                    [ngClass]="
                      quiz.active
                        ? 'bg-success-subtle text-success'
                        : 'bg-secondary-subtle'
                    "
                  >
                    {{ quiz.active ? "Active" : "Draft" }}
                  </span>
                </div>
                <h5 class="card-title fw-bold text-truncate">
                  {{ quiz.title }}
                </h5>
                <p class="card-text text-muted small">
                  {{ quiz.questionsCount }} Questions ‚Ä¢ {{ quiz.createdDate }}
                </p>
                <button
                  class="btn btn-sm btn-outline-primary w-100"
                  [routerLink]="['/quiz-builder', quiz.id]"
                >
                  Edit Quiz
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        *ngIf="currentView === 'library'"
        class="animate__animated animate__fadeIn"
      >
        <div
          class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3"
        >
          <div>
            <h4 class="fw-bold text-dark m-0">My Quiz Library</h4>
            <p class="text-muted small m-0">
              Manage your quizzes and view student reports
            </p>
          </div>
          <button
            class="btn btn-primary shadow-sm fw-bold"
            (click)="openCreateModal()"
          >
            <i class="bi bi-plus-lg me-1"></i> Create New
          </button>
        </div>

        <div class="row g-4">
          <div class="col-12 col-md-6 col-xl-4" *ngFor="let quiz of myQuizzes">
            <div class="card h-100 border-0 shadow-sm hover-card">
              <div class="card-body p-3 p-md-4">
                <div
                  class="d-flex justify-content-between align-items-start mb-3"
                >
                  <div
                    class="rounded-3 bg-primary-subtle text-primary p-3 fw-bold fs-4"
                  >
                    {{ quiz.title.charAt(0) | uppercase }}
                  </div>
                  <div class="dropdown">
                    <button
                      class="btn btn-light btn-sm rounded-circle"
                      type="button"
                      data-bs-toggle="dropdown"
                    >
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                      <li>
                        <button
                          class="dropdown-item"
                          [routerLink]="['/quiz-builder', quiz.id]"
                        >
                          <i class="bi bi-pencil me-2"></i>Edit Questions
                        </button>
                      </li>
                      <li>
                        <button
                          class="dropdown-item"
                          (click)="copyLink(quiz.code)"
                        >
                          <i class="bi bi-share me-2"></i>Share Link
                        </button>
                      </li>
                      <li>
                        <hr class="dropdown-divider" />
                      </li>
                      <li>
                        <button
                          class="dropdown-item text-danger"
                          (click)="deleteQuiz(quiz.id)"
                        >
                          <i class="bi bi-trash me-2"></i>Delete
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>

                <h5 class="card-title fw-bold text-dark mb-1 text-truncate">
                  {{ quiz.title }}
                </h5>
                <div class="mb-3">
                  <span class="badge bg-light text-dark border me-2"
                    ><i class="bi bi-hash"></i> {{ quiz.code }}</span
                  >
                  <span
                    class="badge"
                    [ngClass]="
                      quiz.active
                        ? 'bg-success-subtle text-success'
                        : 'bg-secondary-subtle'
                    "
                  >
                    {{ quiz.active ? "Active" : "Draft" }}
                  </span>
                </div>

                <div
                  class="d-flex justify-content-between text-muted small mb-3"
                >
                  <span class="text-truncate"
                    ><i class="bi bi-question-circle me-1"></i>
                    {{ quiz.questionsCount }} Questions</span
                  >
                  <span
                    ><i class="bi bi-calendar3 me-1"></i>
                    {{ quiz.createdDate }}</span
                  >
                </div>

                <button
                  class="btn btn-outline-primary w-100 fw-bold"
                  (click)="openAnalyticsModal(quiz.id, quiz.title)"
                >
                  <i class="bi bi-bar-chart-line-fill me-2"></i> View Analytics
                </button>
              </div>
            </div>
          </div>

          <div class="col-12" *ngIf="myQuizzes.length === 0">
            <div class="text-center py-5 bg-white rounded shadow-sm">
              <div
                class="bg-light rounded-circle d-inline-flex p-4 mb-3 text-muted"
              >
                <i class="bi bi-journal-plus display-4"></i>
              </div>
              <h5 class="fw-bold">No quizzes created yet</h5>
              <p class="text-muted">
                Create your first quiz to start tracking student performance.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ================= ANALYTICS MODAL ================= -->
      <!-- ================= ANALYTICS MODAL ================= -->
      <div
        class="modal fade"
        id="analyticsModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content border-0 shadow-lg analytics-modal">
            <!-- HEADER -->
            <div class="modal-header bg-white">
              <div>
                <h5 class="modal-title fw-bold text-dark mb-1">
                  Performance Report: {{ selectedReportQuiz }}
                </h5>
                <p class="text-muted small mb-0">
                  Detailed student list and performance metrics
                </p>
              </div>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>

            <!-- DATE FILTER -->
            <div class="date-filter-bar bg-white border-bottom px-4 py-3">
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-3">
                  <label class="form-label small fw-semibold text-muted"
                    >From</label
                  >
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    [(ngModel)]="fromDate"
                  />
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label small fw-semibold text-muted"
                    >To</label
                  >
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    [(ngModel)]="toDate"
                  />
                </div>

                <div
                  class="col-12 col-md-6 d-flex gap-2 justify-content-md-end"
                >
                  <button
                    class="btn btn-sm btn-primary"
                    (click)="loadAnalyticsByDate()"
                  >
                    Apply
                  </button>
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    (click)="resetDateFilter()"
                  >
                    Reset
                  </button>
                  <button
                    class="btn btn-sm btn-success"
                    (click)="openDownloadModal()"
                  >
                    <i class="bi bi-download me-1"></i> Download
                  </button>
                </div>
              </div>
            </div>

            <!-- FILTER BUTTONS -->
            <div class="analytics-filters bg-light border-bottom px-4 py-3">
              <div class="filters-row">
                <button
                  class="btn btn-sm rounded-pill px-3 fw-bold"
                  [class.btn-dark]="activeFilter === 'ALL'"
                  [class.btn-white]="activeFilter !== 'ALL'"
                  (click)="applyFilter('ALL')"
                >
                  All Students ({{ reportParticipants.length }})
                </button>

                <button
                  class="btn btn-sm rounded-pill px-3 fw-bold"
                  [class.btn-success]="activeFilter === 'PASS'"
                  [class.btn-outline-success]="activeFilter !== 'PASS'"
                  (click)="applyFilter('PASS')"
                >
                  <i class="bi bi-check-circle me-1"></i> Passed
                </button>

                <button
                  class="btn btn-sm rounded-pill px-3 fw-bold"
                  [class.btn-danger]="activeFilter === 'FAIL'"
                  [class.btn-outline-danger]="activeFilter !== 'FAIL'"
                  (click)="applyFilter('FAIL')"
                >
                  <i class="bi bi-x-circle me-1"></i> Failed
                </button>

                <div class="ms-auto d-flex gap-2">
                  <button
                    class="btn btn-sm btn-outline-secondary bg-white"
                    (click)="applyFilter('TOP')"
                  >
                    <i class="bi bi-sort-down"></i> Highest
                  </button>
                  <button
                    class="btn btn-sm btn-outline-secondary bg-white"
                    (click)="applyFilter('LOW')"
                  >
                    <i class="bi bi-sort-up"></i> Lowest
                  </button>
                </div>
              </div>
            </div>

            <!-- TABLE (ONLY THIS SCROLLS) -->
            <div class="analytics-table-wrapper">
              <table
                class="table table-hover align-middle mb-0 analytics-table"
              >
                <thead class="table-light sticky-top">
                  <tr>
                    <th class="ps-4">Student</th>
                    <th>Contact</th>
                    <th>Performance</th>
                    <th>Grade</th>
                    <th class="text-end pe-4">Attempted On</th>
                    <th>Action</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngFor="let p of filteredParticipants">
                    <td class="ps-4">
                      <div class="d-flex">
                        <div
                          class="rounded-circle text-white d-flex justify-content-center align-items-center fw-bold me-3"
                          [ngClass]="getAvatarColor(p.name)"
                          style="width: 40px; height: 40px"
                        >
                          {{ p.name.charAt(0) | uppercase }}
                        </div>
                        <div>
                          <div class="fw-bold">{{ p.name }}</div>
                          <div class="small text-muted">
                            ID: #{{ p.email.split("@")[0] }}
                          </div>
                        </div>
                      </div>
                    </td>

                    <td>{{ p.email }}</td>

                    <td>
                      <div class="performance-cell">
                        <span>{{ p.score }} / {{ p.totalQuestions }}</span>
                        <span>{{ p.percentage }}%</span>
                      </div>
                      <div class="progress" style="height: 6px">
                        <div
                          class="progress-bar"
                          [style.width.%]="p.percentage"
                          [ngClass]="
                            p.percentage >= 50 ? 'bg-success' : 'bg-danger'
                          "
                        ></div>
                      </div>
                    </td>

                    <td>
                      <span
                        class="badge rounded-pill px-3 py-2"
                        [ngClass]="
                          p.percentage >= 50
                            ? 'bg-success-subtle text-success'
                            : 'bg-danger-subtle text-danger'
                        "
                      >
                        {{ p.percentage >= 50 ? "PASS" : "FAIL" }}
                      </span>
                    </td>

                    <td class="text-end pe-4 small text-muted">
                      {{ p.attemptDate | date: "mediumDate" }}<br />
                      {{ p.attemptDate | date: "shortTime" }}
                    </td>

                    <td>
                      <!-- <button
                        class="btn btn-sm btn-outline-primary"
                        (click)="openAnswerSheet(p.resultId)"
                      >
                        View
                      </button> -->
<button
  class="btn btn-sm btn-outline-primary"
  [disabled]="!p.resultId"
  (click)="openAnswerSheet(p.resultId)">
  View
</button>


                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer bg-light">
              <button class="btn btn-primary px-4" data-bs-dismiss="modal">
                Close Report
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        *ngIf="currentView === 'history'"
        class="animate__animated animate__fadeIn"
      >
        <div
          class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-3"
        >
          <div>
            <h4 class="fw-bold text-dark m-0">Participation History</h4>
            <p class="text-muted small m-0">
              Track your performance and past attempts
            </p>
          </div>
          <div class="input-group w-100 w-md-auto shadow-sm">
            <span class="input-group-text bg-white border-end-0"
              ><i class="bi bi-search"></i
            ></span>
            <input
              type="text"
              class="form-control border-start-0"
              placeholder="Search history..."
              [(ngModel)]="historySearch"
              (input)="filterHistory()"
            />
          </div>
        </div>

        <div class="row">
          <div class="col-12" *ngFor="let h of filteredHistory">
            <div class="card shadow-sm border-0 mb-3 hover-card">
              <div class="card-body p-3 p-md-4">
                <div class="row align-items-center">
                  <div class="col-12 col-md-4 mb-3 mb-md-0">
                    <div class="d-flex align-items-center">
                      <div class="rounded-3 bg-light text-primary p-3 me-3">
                        <i class="bi bi-journal-text fs-4"></i>
                      </div>
                      <div>
                        <h5 class="fw-bold text-dark mb-1 text-truncate">
                          {{ h.quizTitle }}
                        </h5>

                        <div class="text-muted small">
                          <i class="bi bi-person-badge"></i>
                          Created by:
                          <strong>{{ h.createdByName }}</strong>
                          <span
                            class="ms-1 text-muted"
                            title="{{ h.createdByEmail }}"
                          >
                            ({{ h.createdByEmail }})
                          </span>
                        </div>

                        <span class="badge bg-dark text-white"
                          ><i class="bi bi-hash"></i> {{ h.quizCode }}</span
                        >
                        <span class="text-muted small ms-2">
                          <i class="bi bi-calendar3"></i>
                          {{ h.dateAttempted | date: "mediumDate" }}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-4 mb-3 mb-md-0">
                    <div
                      class="d-flex justify-content-between small fw-bold mb-1"
                    >
                      <span>Score</span>
                      <span
                        [ngClass]="
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? 'text-success'
                            : 'text-danger'
                        "
                      >
                        {{ h.score }} / {{ h.totalQuestions }} ({{
                          getPercentage(h.score, h.totalQuestions)
                        }}%)
                      </span>
                    </div>
                    <div class="progress" style="height: 8px">
                      <div
                        class="progress-bar rounded-pill"
                        role="progressbar"
                        [style.width.%]="
                          getPercentage(h.score, h.totalQuestions)
                        "
                        [ngClass]="
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? 'bg-success'
                            : 'bg-danger'
                        "
                      ></div>
                    </div>
                  </div>

                  <div class="col-12 col-md-4 text-md-end">
                    <span
                      class="badge rounded-pill px-3 py-2 me-3"
                      [ngClass]="
getStatus(h.score, h.totalQuestions) === 'Pass'
                          ? 'bg-success-subtle text-success border border-success'
                          : 'bg-danger-subtle text-danger border border-danger'
                      "
                    >
                      <i
                        class="bi"
                        [ngClass]="
getStatus(h.score, h.totalQuestions) === 'Pass'
                            ? 'bi-check-circle-fill'
                            : 'bi-x-circle-fill'
                        "
                      ></i>
{{ getStatus(h.score, h.totalQuestions) }}
                    </span>

                    <button
                      class="btn btn-warning"
                      *ngIf="h.retakeAllowed"
                      (click)="retakeFromHistory(h)"
                    >
                      üîÅ Retake (Attempt {{ h.attemptNumber + 1 }})
                    </button>

                    <button
                      *ngIf="!h.retakeAllowed"
                      class="btn btn-outline-primary btn-sm rounded-pill px-3"
                      (click)="openAnswerSheet(h.id)"
                    >
                      View Report <i class="bi bi-arrow-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="filteredHistory.length === 0" class="text-center py-5">
          <div
            class="bg-light rounded-circle d-inline-flex p-4 mb-3 text-muted"
          >
            <i class="bi bi-clock-history display-4"></i>
          </div>
          <h5 class="fw-bold text-muted">No history found</h5>
          <p class="text-muted small">
            You haven't taken any quizzes yet, or no results match your search.
          </p>
          <button
            class="btn btn-primary px-4 mt-2"
            (click)="switchView('dashboard')"
          >
            Go to Dashboard
          </button>
        </div>
      </div>

      <div
        *ngIf="currentView === 'settings'"
        class="animate__animated animate__fadeIn"
      >
        <div class="row justify-content-center">
          <div class="col-12 col-lg-8">
            <div class="card shadow-sm border-0">
              <div class="card-body p-3 p-md-5">
                <h4 class="mb-4 fw-bold">Account Settings</h4>

                <h6 class="text-muted border-bottom pb-2 mb-3">
                  Profile Details
                </h6>
                <div class="row mb-4">
                  <div class="col-12 col-md-3 text-center mb-3 mb-md-0">
                    <div class="position-relative d-inline-block">
                      <img
                        [src]="
                          imagePreview ||
                          currentUser.profileImageUrl ||
                          'assets/img/default-avatar.png'
                        "
                        class="rounded-circle border shadow-sm"
                        width="100"
                        height="100"
                        style="object-fit: cover"
                      />
                      <label
                        for="settingUpload"
                        class="position-absolute bottom-0 end-0 bg-white border rounded-circle p-1 shadow-sm"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-camera-fill text-primary"></i>
                      </label>
                      <input
                        type="file"
                        id="settingUpload"
                        class="d-none"
                        (change)="onProfileImageSelected($event)"
                        accept="image/*"
                      />
                    </div>
                  </div>
                  <div class="col-12 col-md-9">
                    <div class="mb-3">
                      <label class="form-label small fw-bold">Full Name</label>
                      <input
                        type="text"
                        class="form-control"
                        [(ngModel)]="currentUser.name"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label small fw-bold">Email</label>
                      <input
                        type="text"
                        class="form-control bg-light"
                        [value]="currentUser.email"
                        disabled
                      />
                    </div>

                    <div class="row mb-3">
                      <div class="col-6">
                        <label class="form-label small text-muted"
                          >User Type</label
                        >
                        <div
                          class="form-control bg-light text-uppercase fw-bold"
                        >
                          {{ currentUser.userType }}
                        </div>
                      </div>
                      <div class="col-6">
                        <label class="form-label small text-muted"
                          >Institution</label
                        >
                        <div
                          class="form-control bg-light fw-bold text-truncate"
                        >
                          {{ institutionDetails.instituteName }}
                        </div>
                        <div
                          class="form-control bg-light text-muted text-truncate mt-1"
                        >
                          {{ institutionDetails.instituteLocation }}
                        </div>
                      </div>
                    </div>
                    <button
                      class="btn btn-primary px-4"
                      (click)="updateProfile()"
                    >
                      Save Profile
                    </button>
                  </div>
                </div>

                <h6 class="text-muted border-bottom pb-2 mb-3 mt-4">
                  Security
                </h6>
                <form (ngSubmit)="changePassword()">
                  <div class="row">
                    <div class="col-12 col-md-4 mb-3">
                      <label class="form-label small fw-bold"
                        >Current Password</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        [(ngModel)]="passwordData.currentPassword"
                        name="cp"
                      />
                    </div>
                    <div class="col-12 col-md-4 mb-3">
                      <label class="form-label small fw-bold"
                        >New Password</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        [(ngModel)]="passwordData.newPassword"
                        name="np"
                      />
                    </div>
                    <div class="col-12 col-md-4 mb-3">
                      <label class="form-label small fw-bold">Confirm</label>
                      <input
                        type="password"
                        class="form-control"
                        [(ngModel)]="passwordData.confirmPassword"
                        name="cfp"
                      />
                    </div>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-danger px-4">
                      Update Password
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- page-content-wrapper -->
</div>

<!-- wrapper -->

<!-- ================= DOWNLOAD FORMAT MODAL ================= -->
<div
  class="modal fade"
  id="downloadFormatModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Download Report</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p class="mb-3 fw-semibold">Choose download format</p>
        <div *ngIf="isDownloading" class="mt-3">
  <div class="d-flex align-items-center gap-2 justify-content-center">
    <div class="spinner-border text-primary"></div>
    <div class="fw-semibold">
      Downloading‚Ä¶ {{ downloadProgress }}%
    </div>
  </div>

  <div class="progress mt-2">
    <div
      class="progress-bar progress-bar-striped progress-bar-animated"
      [style.width.%]="downloadProgress">
    </div>
  </div>
</div>

<div class="d-flex justify-content-center gap-3 mt-3">
  <button
    class="btn btn-success px-4"
    [disabled]="isDownloading"
    (click)="confirmDownload('CSV')">
    Excel (CSV)
  </button>

  <button
    class="btn btn-danger px-4"
    [disabled]="isDownloading"
    (click)="confirmDownload('PDF')">
    PDF
  </button>
</div>
      </div>
    </div>
  </div>
</div>

<!-- ================= ANSWER SHEET MODAL ================= -->
<div class="modal fade" id="answerSheetModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">
          {{ answerSheet?.quizTitle }} ‚Äî Answer Sheet
        </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3 text-muted small">
          Score:
          <strong
            >{{ answerSheet?.score }}/{{ answerSheet?.totalQuestions }}</strong
          >
        </div>

        <div
          *ngFor="let q of answerSheet?.questions; let i = index"
          class="border rounded p-3 mb-3"
        >
          <div class="fw-bold mb-2">Q{{ i + 1 }}. {{ q.content }}</div>

<div
  *ngFor="let opt of q.options"
  class="p-2 rounded mb-1 border"
  [ngClass]="{
    'bg-success-subtle border-success':
      opt === q.correctAnswer,

    'bg-danger-subtle border-danger':
      answerSheet?.userAnswers[q.id] === opt &&
      opt !== q.correctAnswer
  }"
>
  {{ opt }}

  <!-- ‚úÖ Correct answer badge (always visible) -->
  <span
    *ngIf="opt === q.correctAnswer"
    class="badge bg-success ms-2"
  >
    Correct Answer
  </span>

  <!-- ‚ùå Wrong selected option badge -->
  <span
    *ngIf="
      answerSheet?.userAnswers[q.id] === opt &&
      opt !== q.correctAnswer
    "
    class="badge bg-danger ms-2"
  >
    Your Answer
  </span>
</div>

          <!-- ‚≠ï NOT ATTEMPTED LABEL -->
          <div
            *ngIf="answerSheet?.userAnswers[q.id] == null"
            class="mt-2 text-warning fw-bold"
          >
            ‚≠ï Not Attempted
          </div>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button
          class="btn btn-danger"
          (click)="downloadAnswerSheetPdf(selectedResultId)"
        >
          <i class="bi bi-file-earmark-pdf-fill me-1"></i>
          Download PDF
        </button>
        <!-- <button
  *ngIf="answerSheet?.retakeAllowed"
  class="btn btn-warning"
  (click)="retakeQuiz()">

  üîÅ Retake Quiz (Attempt {{ answerSheet.attemptNumber + 1 }})
</button> -->
        <button
          *ngIf="
            !answerSheet?.retakeAllowed &&
            answerSheet?.facultyEmail === currentUser?.email
          "
          class="btn btn-sm btn-warning"
          (click)="confirmAndRetake()"
        >
          Allow Retake
        </button>

        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= CREATE QUIZ MODAL ================= -->
<div class="modal fade" id="createQuizModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow border-0">
      <div class="modal-header">
        <h5 class="fw-bold">Create Quiz</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input
          class="form-control mb-2"
          placeholder="Quiz Title"
          [(ngModel)]="newQuiz.title"
        />

        <textarea
          class="form-control mb-3"
          placeholder="Description"
          [(ngModel)]="newQuiz.description"
        >
        </textarea>

        <!-- üîΩ Import Questions -->
        <div class="border rounded p-3 bg-light">
          <label class="form-label fw-semibold small">
            Import Questions (optional)
          </label>

          <!-- Template actions -->
          <div class="d-flex gap-2 mb-2">
            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              (click)="downloadTemplate('csv')"
            >
              <i class="bi bi-download"></i> CSV Template
            </button>

            <button
              type="button"
              class="btn btn-outline-secondary btn-sm"
              (click)="downloadTemplate('txt')"
            >
              <i class="bi bi-download"></i> TXT Template
            </button>
          </div>

          <input
            type="file"
            class="form-control"
            (change)="onImportFileSelected($event)"
            accept=".csv,.txt"
          />

          <div class="form-text text-muted mt-1">
            Download template ‚Üí fill questions ‚Üí upload here
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-primary" (click)="createQuiz()">Create</button>
      </div>
    </div>
  </div>
</div>
