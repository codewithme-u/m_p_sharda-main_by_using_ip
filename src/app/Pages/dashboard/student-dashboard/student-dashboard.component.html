<div class="d-flex" id="wrapper">
  <!-- Sidebar (desktop) -->
  <aside
    class="bg-white border-end sticky-top d-none d-md-block"
    id="sidebar"
    style="min-width: 260px; height: 100vh; overflow-y: auto"
  >
    <div class="sidebar-heading text-center py-4 border-bottom mb-2">
      <div class="fw-bold text-primary fs-4">
        <i class="bi bi-mortarboard-fill me-2"></i>Student Portal
      </div>
      <small class="text-muted d-block">Learning Management</small>
    </div>

    <!-- NAV -->
    <div class="list-group list-group-flush px-2">
      <button
        class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'dashboard'"
        (click)="switchView('dashboard')"
      >
        <i class="bi bi-grid-1x2-fill me-2"></i> Overview
      </button>

      <button
        class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'results'"
        (click)="switchView('results')"
      >
        <i class="bi bi-journal-text me-2"></i> My Results
      </button>

      <button
        class="list-group-item list-group-item-action text-danger border-0 mt-4"
        (click)="logout()"
      >
        <i class="bi bi-box-arrow-left me-2"></i> Logout
      </button>
    </div>
  </aside>

  <!-- Offcanvas sidebar for small devices -->
  <div
    class="offcanvas offcanvas-start d-md-none"
    tabindex="-1"
    id="mobileSidebar"
    aria-labelledby="mobileSidebarLabel"
  >
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileSidebarLabel">
        <i class="bi bi-mortarboard-fill me-2"></i>Student Portal
      </h5>
      <button
        type="button"
        class="btn-close text-reset"
        data-bs-dismiss="offcanvas"
        aria-label="Close"
      ></button>
    </div>
    <div class="offcanvas-body p-0">
      <div class="list-group list-group-flush px-2">
        <button
          class="list-group-item list-group-item-action border-0 rounded mb-2"
          [class.active-tab]="currentView === 'dashboard'"
          (click)="switchView('dashboard')"
          data-bs-dismiss="offcanvas"
        >
          <i class="bi bi-grid-1x2-fill me-2"></i> Overview
        </button>

        <button
          class="list-group-item list-group-item-action border-0 rounded mb-2"
          [class.active-tab]="currentView === 'results'"
          (click)="switchView('results')"
          data-bs-dismiss="offcanvas"
        >
          <i class="bi bi-journal-text me-2"></i> My Results
        </button>

        <button
          class="list-group-item list-group-item-action text-danger border-0 mt-4"
          (click)="logout()"
        >
          <i class="bi bi-box-arrow-left me-2"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="page-content-wrapper" class="w-100 bg-light">
    <!-- Top navbar -->
    <nav
      class="navbar navbar-light bg-white border-bottom shadow-sm px-3 px-md-4 py-2"
    >
      <div class="d-flex align-items-center w-100">
        <!-- Mobile toggle -->
        <button
          class="btn d-md-none me-3 p-0"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileSidebar"
          aria-controls="mobileSidebar"
          aria-label="Toggle navigation"
        >
          <i class="bi bi-list fs-3 text-dark"></i>
        </button>

        <div class="d-flex align-items-center">
          <h5
            class="m-0 fw-bold text-dark text-uppercase small text-truncate"
            style="max-width: 220px"
          >
            {{ currentView }}
          </h5>
        </div>
        <div
          class="ms-auto d-flex align-items-center"
          *ngIf="currentUser as user"
          (click)="switchView('settings')"
        >
          <span class="me-3 text-muted small d-none d-sm-inline">
            Welcome, <strong>{{ user.name }}</strong>
          </span>

          <img
            *ngIf="user.profileImageUrl"
            [src]="user.profileImageUrl"
            (error)="user.profileImageUrl = null"
            class="rounded-circle border"
            width="40"
            height="40"
            style="object-fit: cover"
          />

          <div
            *ngIf="!user.profileImageUrl"
            class="rounded-circle bg-dark text-white d-flex justify-content-center align-items-center fw-bold"
            style="width: 40px; height: 40px"
          >
            {{ (user.name || "U").charAt(0) | uppercase }}
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid p-3 p-md-4">
      <!-- DASHBOARD VIEW -->
      <div
        *ngIf="currentView === 'dashboard'"
        class="animate__animated animate__fadeIn"
      >
        <div class="row justify-content-center mb-4">
          <div class="col-12 col-sm-10 col-md-8 col-lg-6">
            <div
              class="card border-0 shadow-sm bg-white rounded-3 text-center p-4 p-md-5 hover-card"
            >
              <div class="mb-3">
                <i class="bi bi-pencil-square fs-1 text-primary"></i>
              </div>
              <h3 class="fw-bold mb-2">Join an Exam</h3>
              <p class="text-muted mb-3 small">
                Enter the exam code provided by your faculty
              </p>
              <div class="input-group input-group-lg shadow-sm">
                <input
                  type="text"
                  class="form-control border-primary"
                  placeholder="e.g. MATH-101"
                  [(ngModel)]="examCode"
                  style="text-transform: uppercase"
                />
                <button
                  class="btn btn-primary px-4 fw-bold"
                  (click)="joinExam()"
                >
                  START <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Metrics -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-md-4">
            <div
              class="card border-0 shadow-sm h-100 p-3 p-md-4 border-start border-4 border-primary"
            >
              <div class="card-body p-0">
                <h6 class="text-muted text-uppercase small">Exams Attempted</h6>
                <h2 class="mb-0 fw-bold text-dark">{{ stats.totalTests }}</h2>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div
              class="card border-0 shadow-sm h-100 p-3 p-md-4 border-start border-4 border-success"
            >
              <div class="card-body p-0">
                <h6 class="text-muted text-uppercase small">Average Score</h6>
                <h2 class="mb-0 fw-bold text-dark">{{ stats.avgScore }}%</h2>
                <small class="text-success" *ngIf="stats.avgScore >= 75"
                  ><i class="bi bi-graph-up"></i> Excellent</small
                >
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div
              class="card border-0 shadow-sm h-100 p-3 p-md-4 border-start border-4 border-info"
            >
              <div class="card-body p-0">
                <h6 class="text-muted text-uppercase small">Pass Rate</h6>
                <h2 class="mb-0 fw-bold text-dark">
                  {{ getPercentage(stats.passed, stats.totalTests) }}%
                </h2>
                <small class="text-muted"
                  >{{ stats.passed }} Passed / {{ stats.failed }} Needs
                  Improvement</small
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Recent results -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold m-0">Recent Results</h5>
          <button
            class="btn btn-link text-decoration-none"
            (click)="switchView('results')"
          >
            View Full History
          </button>
        </div>

        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="ps-4">Exam Title</th>
                    <th>Score</th>
                    <th>Status</th>
                    <th class="text-end pe-4">Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let h of historyList.slice(0, 3)">
                    <td class="ps-4 fw-bold text-truncate">
                      {{ h.quizTitle }}
                    </td>
                    <td>
                      <span
                        [ngClass]="
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? 'text-success fw-bold'
                            : 'text-danger fw-bold'
                        "
                      >
                        {{ h.score }} / {{ h.totalQuestions }}
                      </span>
                    </td>
                    <td>
                      <span
                        class="badge rounded-pill"
                        [ngClass]="
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? 'bg-success-subtle text-success'
                            : 'bg-danger-subtle text-danger'
                        "
                      >
                        {{
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? "Passed"
                            : "Failed"
                        }}
                      </span>
                    </td>
                    <td class="text-end pe-4 text-muted small">
                      {{ formatDateShort(h.dateAttempted) }}
                    </td>
                  </tr>
                  <tr *ngIf="historyList.length === 0">
                    <td colspan="4" class="text-center py-4 text-muted">
                      No recent activity found.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULTS VIEW -->
      <div
        *ngIf="currentView === 'results'"
        class="animate__animated animate__fadeIn"
      >
        <div class="card border-0 shadow-sm">
          <div
            class="card-header bg-white py-3 d-flex justify-content-between align-items-center"
          >
            <h5 class="m-0 fw-bold">Exam History</h5>
            <span class="badge bg-primary"
              >{{ historyList.length }} Records</span
            >
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="ps-4">Code</th>
                    <th>Title</th>
                    <th>Score</th>
                    <th>Result</th>
                    <th>Date</th>
                    <th class="text-end pe-4">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let h of historyList">
                    <td class="ps-4">
                      <span class="badge bg-light text-dark border">{{
                        h.quizCode
                      }}</span>
                    </td>
                    <td class="fw-bold text-truncate">{{ h.quizTitle }}</td>
                    <td>
                      {{ h.score }} / {{ h.totalQuestions }}
                      <small class="text-muted"
                        >({{
                          getPercentage(h.score, h.totalQuestions)
                        }}%)</small
                      >
                    </td>
                    <td>
                      <span
                        class="badge rounded-pill"
                        [ngClass]="
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? 'bg-success'
                            : 'bg-danger'
                        "
                      >
                        {{
                          getPercentage(h.score, h.totalQuestions) >= 50
                            ? "PASS"
                            : "FAIL"
                        }}
                      </span>
                    </td>
                    <td class="text-muted small">
                      {{ formatDateShort(h.dateAttempted) }}
                    </td>
                    <!-- <td class="text-end pe-4">
                      <button
                        class="btn btn-sm btn-outline-primary"
                        (click)="openReview(h.id)"
                      >
                        Review
                      </button>
                    </td> -->
                    <td class="text-end pe-4 d-flex gap-2 justify-content-end">

  <!-- REVIEW -->
<button
  class="btn btn-sm btn-outline-primary"
  (click)="openAnswerSheet(h.id)"
>
  Review
</button>


  <!-- RETAKE (only if allowed) -->
<button
  *ngIf="h.retakeAllowed"
  class="btn btn-sm btn-warning"
  (click)="retakeFromHistory(h)"
>
  üîÅ Retake
  <small class="ms-1 text-muted">(Attempt {{ h.attemptNumber }})</small>
</button>


</td>

                  </tr>
                  <tr *ngIf="historyList.length === 0">
                    <td colspan="6" class="text-center py-5 text-muted">
                      No exam records found.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS VIEW -->
      <div
        *ngIf="currentView === 'settings' && currentUser as user"
        class="animate__animated animate__fadeIn"
      >
        <div class="row justify-content-center">
          <div class="col-12 col-lg-8">
            <div class="card shadow-sm border-0">
              <div class="card-body p-3 p-md-5">
                <h4 class="mb-4 fw-bold">Account Settings</h4>

                <div class="row mb-4">
                  <div class="col-12 col-md-3 text-center mb-3 mb-md-0">
                    <div class="position-relative d-inline-block">
                      <img
                        [src]="
                          imagePreview ||
                          currentUser.profileImageUrl ||
                          'assets/img/default-avatar.png'
                        "
                        class="rounded-circle border shadow-sm"
                        width="100"
                        height="100"
                        style="object-fit: cover"
                      />
                      <label
                        for="settingUpload"
                        class="position-absolute bottom-0 end-0 bg-white border rounded-circle p-1 shadow-sm"
                        style="cursor: pointer"
                      >
                        <i class="bi bi-camera-fill text-primary"></i>
                      </label>
                      <input
                        type="file"
                        id="settingUpload"
                        class="d-none"
                        (change)="onProfileImageSelected($event)"
                        accept="image/*"
                      />
                    </div>
                  </div>

                  <div class="col-12 col-md-9">
                    <div class="mb-3">
                      <label class="form-label small fw-bold">Full Name</label>
                      <input
                        type="text"
                        class="form-control"
                        [(ngModel)]="user.name"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label small fw-bold">Email</label>
                      <input
                        type="text"
                        class="form-control bg-light"
                        [value]="currentUser.email"
                        disabled
                      />
                    </div>

                    <div class="row mb-3">
                      <div class="col-6">
                        <label class="form-label small text-muted"
                          >User Type</label
                        >
                        <div
                          class="form-control bg-light text-uppercase fw-bold"
                        >
{{ currentUser.userType }}                        </div>
                      </div>
                      <div class="col-6">
                        <label class="form-label small text-muted"
                          >Institution</label
                        >
                        <div
                          class="form-control bg-light fw-bold text-truncate"
                        >
{{ institutionDetails.instituteName }}                        </div>
                        <div
                          class="form-control bg-light text-muted text-truncate mt-1"
                        >
{{ institutionDetails.instituteLocation }}                        </div>
                      </div>
                    </div>
                    <button
                      class="btn btn-primary px-4"
                      (click)="updateProfile()"
                    >
                      Save Profile
                    </button>
                  </div>
                </div>

                <h6 class="text-muted border-bottom pb-2 mb-3 mt-4">
                  Security
                </h6>
                <form (ngSubmit)="changePassword()">
                  <div class="row">
                    <div class="col-12 col-md-4 mb-3">
                      <label class="form-label small fw-bold"
                        >Current Password</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        [(ngModel)]="passwordData.currentPassword"
                        name="cp"
                      />
                    </div>
                    <div class="col-12 col-md-4 mb-3">
                      <label class="form-label small fw-bold"
                        >New Password</label
                      >
                      <input
                        type="password"
                        class="form-control"
                        [(ngModel)]="passwordData.newPassword"
                        name="np"
                      />
                    </div>
                    <div class="col-12 col-md-4 mb-3">
                      <label class="form-label small fw-bold">Confirm</label>
                      <input
                        type="password"
                        class="form-control"
                        [(ngModel)]="passwordData.confirmPassword"
                        name="cfp"
                      />
                    </div>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-danger px-4">
                      Update Password
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- container-fluid -->
  </div>
  <!-- page-content-wrapper -->
</div>
<!-- wrapper -->

<!-- ================= ANSWER SHEET MODAL ================= -->
<div class="modal fade" id="answerSheetModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">
          {{ answerSheet?.quizTitle }} ‚Äî Answer Sheet
        </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3 text-muted small">
          Score:
          <strong>
            {{ answerSheet?.score }}/{{ answerSheet?.totalQuestions }}
          </strong>
        </div>

        <div
          *ngFor="let q of answerSheet?.questions; let i = index"
          class="border rounded p-3 mb-3"
        >
          <div class="fw-bold mb-2">
            Q{{ i + 1 }}. {{ q.content }}
          </div>

<div
  *ngFor="let opt of q.options"
  class="p-2 rounded mb-1 border"
  [ngClass]="{
    'bg-success-subtle border-success':
      opt === q.correctAnswer,

    'bg-danger-subtle border-danger':
      answerSheet?.userAnswers[q.id] === opt &&
      opt !== q.correctAnswer
  }"
>
  {{ opt }}

  <!-- ‚úÖ Correct answer badge (always visible) -->
  <span
    *ngIf="opt === q.correctAnswer"
    class="badge bg-success ms-2"
  >
    Correct Answer
  </span>

  <!-- ‚ùå Wrong selected option badge -->
  <span
    *ngIf="
      answerSheet?.userAnswers[q.id] === opt &&
      opt !== q.correctAnswer
    "
    class="badge bg-danger ms-2"
  >
    Your Answer
  </span>
</div>


          <div
            *ngIf="answerSheet?.userAnswers[q.id] == null"
            class="mt-2 text-warning fw-bold"
          >
            ‚≠ï Not Attempted
          </div>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button
          class="btn btn-danger"
          (click)="downloadAnswerSheetPdf(selectedResultId)"
        >
          <i class="bi bi-file-earmark-pdf-fill me-1"></i>
          Download PDF
        </button>

        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

